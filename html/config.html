<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">

  <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'>
    <style>svg{background:white;}path{fill:black;}@media(prefers-color-scheme:dark){svg{background:black;}path{fill:white;}}</style>
  <path
    d='M10 2a2 2 0 0 1-1.5 1.937v5.087c.863.083 1.5.377 1.5.726 0 .414-.895.75-2 .75s-2-.336-2-.75c0-.35.637-.643 1.5-.726V3.937A2 2 0 1 1 10 2z' />
  <path
    d='M0 9.665v1.717a1 1 0 0 0 .553.894l6.553 3.277a2 2 0 0 0 1.788 0l6.553-3.277a1 1 0 0 0 .553-.894V9.665c0-.1-.06-.19-.152-.23L9.5 6.715v.993l5.227 2.178a.125.125 0 0 1 .001.23l-5.94 2.546a2 2 0 0 1-1.576 0l-5.94-2.546a.125.125 0 0 1 .001-.23L6.5 7.708l-.013-.988L.152 9.435a.25.25 0 0 0-.152.23z' />
  </svg>" />

  <title>PTZ Status and Config</title>

  <!-- Bootstrap core CSS -->
  <link defer href="bootstrap.min.css" rel="stylesheet">
  <!-- Custom styles for this template -->
  <link defer href="headers.css" rel="stylesheet">
  <!-- https://stackoverflow.com/questions/55493629/rectangular-shape-behind-text-in-css -->
  <style>
    .nodisplay { display:none;}
    #joystickContainer {
      text-align: center;
    }

    /*
    #joystickDeadZone {
    }
    */

    #joystickDeadZone:before {
      margin-top: -1em;
      content: '';
      position: absolute;
      width: calc(100%*.2);
      height: 2em;
      margin: auto;
      z-index: 1;
      border: 5px solid lightgray;
      left: calc((100% / 2 - 0px) - (100% * .2 / 2 - 0px));
    }
  </style>
  <script defer src="bootstrap.bundle.min.js"></script>
  <script defer src="validate-forms.js"></script>
  <!-- Needed for Firmware upload -- assuming you've got interenet to fetch this -->
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
  <script>
    LogCallback = null;
    ptzSocket = null;
    Networks = [
      { "name": "Ethernet", "status": "off", "ip": "10.0.4.40", "ssid": "-", "info": "tbd" },
      { "name": "WiFi", "status": "up", "ip": "10.0.4.40", "ssid": "KilroyNetwork", "info": "tbd" },
      { "name": "Hotspot", "status": "down", "ip": "10.0.4.40", "ssid": "ptz-config", "info": "tbd" },
    ];
    ATEMSwitcher = [
      { "status": "down", "name": "ATEM Mini Pro", "ip": "10.0.4.40", "port": "-", "protocol": "1" },
    ];
    ATEMCameras = [
      { "id": "0", "status": "down", "name": "Camera 1", "ip": "10.0.4.40", "port": "5678", "protocol": "1", "headers": "0" },
      { "id": "1", "status": "up", "name": "Camera 2", "ip": "10.0.4.62", "port": "60578", "protocol": "0", "headers": "1" },
      { "id": "2", "status": "off", "name": "H2R", "ip": "0.0.0.0", "port": "0", "protocol": "", "headers": "1" },
      { "id": "3", "status": "off", "name": "AV PC", "ip": "0.0.0.0", "port": "0", "protocol": "", "headers": "1" },
      { "id": "4", "status": "off", "name": "Cam5", "ip": "0.0.0.0", "port": "0", "protocol": "", "headers": "1" },
      { "id": "5", "status": "off", "name": "Cam6", "ip": "0.0.0.0", "port": "0", "protocol": "", "headers": "1" },
      { "id": "6", "status": "up", "name": "Tracker", "ip": "10.0.4.171", "port": "5678", "protocol": "1", "headers": "0" },
      { "id": "7", "status": "off", "name": "Cam8", "ip": "0.0.0.0", "port": "0", "protocol": "0", "headers": "1" }
    ];
    DiscoveredCameras = [
      { "name": "HD Camera", "ip": "10.0.4.40", "port": "5678", "protocol": "0", "headers": "1" },
      { "name": "HD Camera30x", "ip": "10.0.4.62", "port": "60578", "protocol": "0", "headers": "1" }
    ];

    function updateNetworks() {
      let template = document.getElementById("networkStatus");
      for (let i = 0; i < Networks.length; i++) {
        let cls = "alert align-items-center alert-success";
        let icn = "#check-circle-fill";
        if (Networks[i].status == "down") {
          cls = "alert align-items-center alert-danger";
          icn = "#exclamation-triangle-fill";
        } else if (Networks[i].status == "off") {
          cls = "alert align-items-center alert-dark";
          icn = "#exclamation-triangle-fill";
        }

        let clone = template.cloneNode(true);
        clone.id = "networkStatus" + Networks[i].name;
        template.parentNode.appendChild(clone);
        let clss = document.querySelectorAll("#" + clone.id + "  #networkStatusClass")[0];
        clss.id = "networkStatusClass" + Networks[i].name;
        clss.className = cls;
        let icon = document.querySelectorAll("#" + clone.id + " #networkStatusIcon")[0];
        icon.id = "networkStatusIcon" + Networks[i].name;
        icon.setAttribute('href', icn);
        let name = document.querySelectorAll("#" + clone.id + "  #networkStatusName")[0];
        name.id = "networkStatusName" + Networks[i].name;
        name.innerHTML = Networks[i].name;
        let ip = document.querySelectorAll("#" + clone.id + "  #networkStatusIP")[0];
        ip.id = "networkStatusIP" + Networks[i].name;
        ip.innerHTML = Networks[i].ip;
        let ssid = document.querySelectorAll("#" + clone.id + "  #networkStatusSSID")[0];
        ssid.id = "networkStatusSSID" + Networks[i].ssid;
        ssid.innerHTML = Networks[i].ssid;
        let info = document.querySelectorAll("#" + clone.id + "  #networkStatusInfo")[0];
        info.id = "networkStatusInfo" + Networks[i].name;
        info.innerHTML = Networks[i].info;
      }
      template.remove();
    }
    function updateSwitcherStatus() {
      let cls = "alert align-items-center alert-success";
      let icon = "#check-circle-fill";
      if (ATEMSwitcher[0].status == "down") {
        cls = "alert align-items-center alert-danger";
        icon = "#exclamation-triangle-fill";
      } else if (ATEMSwitcher[0].status == "off") {
        cls = "alert align-items-center alert-warning";
        icon = "#exclamation-triangle-fill";
      } else if (ATEMSwitcher[0].status == "na") {
        cls = "alert align-items-center alert-dark";
        icon = "#dash-circle-fill";
      }
      let protocol = "UDP";
      if (ATEMSwitcher[0].protocol == "1") {
        protocol = "TCP";
      }
      document.getElementById("atemSwitcherClass").className = cls;
      document.getElementById("atemSwitcherIcon").setAttribute('href', icon);
      document.getElementById("atemSwitcherName").innerHTML = ATEMSwitcher[0].name;
      document.getElementById("atemSwitcherProtocol").innerHTML = protocol;
      document.getElementById("atemSwitcherIP").innerHTML = ATEMSwitcher[0].ip;
      document.getElementById("atemSwitcherPort").innerHTML = ATEMSwitcher[0].port;
    }

    function updateCameraStatus() {
      let template = document.getElementById("camStatus");

      for (let i = 0; i < ATEMCameras.length; i++) {
        let cls = "alert align-items-center alert-success";
        let icon = "#check-circle-fill";
        if (ATEMCameras[i].status == "down") {
          cls = "alert align-items-center alert-danger";
          icon = "#exclamation-triangle-fill";
        } else if (ATEMCameras[i].status == "off") {
          cls = "alert align-items-center alert-warning";
          icon = "#exclamation-triangle-fill";
        } else if (ATEMCameras[i].status == "na") {
          cls = "alert align-items-center alert-dark";
          icon = "#dash-circle-fill";
        }
        let protocol = "UDP";
        if (ATEMCameras[i].protocol == "1") {
          protocol = "TCP";
        } else if (ATEMCameras[i].protocol == "2") {
          protocol = "ONVIF";
        }

        clone = template.cloneNode(true);
        clone.id = "camStatus" + i;
        template.parentNode.appendChild(clone);
        document.querySelectorAll("#" + clone.id + "  #camStatusClass")[0].id = "camStatusClass" + i;
        document.querySelectorAll("#" + clone.id + " #camStatusIcon")[0].id = "camStatusIcon" + i;
        document.querySelectorAll("#" + clone.id + "  #camStatusName")[0].id = "camStatusName" + i;
        document.querySelectorAll("#" + clone.id + " #camStatusProtocol")[0].id = "camStatusProtocol" + i;
        document.querySelectorAll("#" + clone.id + "  #camStatusIP")[0].id = "camStatusIP" + i;
        document.querySelectorAll("#" + clone.id + "  #camStatusPort")[0].id = "camStatusPort" + i;

        document.getElementById("camStatusClass" + i).className = cls;
        document.getElementById("camStatusIcon" + i).setAttribute('href', icon);
        document.getElementById("camStatusName" + i).innerHTML = ATEMCameras[i].name;
        document.getElementById("camStatusProtocol" + i).innerHTML = protocol;
        document.getElementById("camStatusIP" + i).innerHTML = ATEMCameras[i].ip;
        document.getElementById("camStatusPort" + i).innerHTML = ATEMCameras[i].port;
      }

      template.remove();
    }

    function updateCameraConfig() {
      document.getElementById("atemConfigName").innerHTML = ATEMSwitcher[0].name;
      document.getElementById("atemConfigIP").value = ATEMSwitcher[0].ip;

      let template = document.getElementById("camConfig");
      for (let i = 0; i < ATEMCameras.length; i++) {
        let clone = template.cloneNode(true);
        clone.id = "camConfig" + i;
        template.parentNode.appendChild(clone);
        // document.querySelectorAll("#" + clone.id + "  #camConfigToggle")[0].name = "camConfigToggle" + i;
        document.querySelectorAll("#" + clone.id + "  #camConfigName")[0].name = "camConfigName" + i;
        document.querySelectorAll("#" + clone.id + "  #camConfigProtocol")[0].name = "camConfigProtocol" + i;
        document.querySelectorAll("#" + clone.id + "  #camConfigIP")[0].name = "camConfigIP" + i;
        document.querySelectorAll("#" + clone.id + "  #camConfigPort")[0].name = "camConfigPort" + i;
        // document.querySelectorAll("#" + clone.id + "  #camConfigToggle")[0].id = "camConfigToggle" + i;

        // ?? need to save and restore the toggle, then select the toggle as clicked
        // ?? What should the checkmark do? remove it from the status page?
        // or should I jsut get rid of the checkmark and simplify things (yes)
        document.querySelectorAll("#" + clone.id + "  #camConfigName")[0].id = "camConfigName" + i;
        document.querySelectorAll("#" + clone.id + "  #camConfigProtocol")[0].id = "camConfigProtocol" + i;
        document.querySelectorAll("#" + clone.id + "  #camConfigIP")[0].id = "camConfigIP" + i;
        document.querySelectorAll("#" + clone.id + "  #camConfigPort")[0].id = "camConfigPort" + i;

        document.getElementById("camConfigName" + i).innerHTML = ATEMCameras[i].name;
        document.getElementById("camConfigProtocol" + i).value = ATEMCameras[i].protocol;
        document.getElementById("camConfigIP" + i).value = ATEMCameras[i].ip;
        document.getElementById("camConfigPort" + i).value = ATEMCameras[i].port;
      }
      template.remove();
    }

    function assignDiscoveredCameras() {
      for (let i = 0; i < DiscoveredCameras.length; i++) {
        let a = document.getElementById("dcAtemCam" + i).value;
        if (a != "") {
          //console.log("discovered camera: " + i + " selected atem cam: " + atemCamNum);
          document.getElementById("camConfigProtocol" + a).value = DiscoveredCameras[i].protocol;
          document.getElementById("camConfigIP" + a).value = DiscoveredCameras[i].ip;
          document.getElementById("camConfigPort" + a).value = DiscoveredCameras[i].port;
          //document.getElementById("camConfigHeaders" + a).value = DiscoveredCameras[i].headers;
        }
      }
    }
    function drawDiscoveredCameras() {
      let div = document.createElement("div")
      div.id = "discoveredCameras";

      for (let i = 0; i < DiscoveredCameras.length; i++) {
        let ig = document.createElement("div");
        div.appendChild(ig);
        ig.className = "input-group mb-3";
        let dcName = document.createElement("span");
        ig.appendChild(dcName);
        dcName.className = "input-group-text col-4";
        dcName.id = "discovedCam0Name";
        dcName.innerHTML = DiscoveredCameras[i].name;
        let dcIP = document.createElement("span");
        ig.appendChild(dcIP);
        dcIP.className = "input-group-text col-4";
        dcIP.id = "discovedCam0IP";
        dcIP.innerHTML = DiscoveredCameras[i].ip;
        let dcSelect = document.createElement("select");
        ig.appendChild(dcSelect);
        dcSelect.className = "form-select col-4";
        dcSelect.id = "dcAtemCam" + i;
        let dcOption0 = document.createElement("option");
        dcSelect.appendChild(dcOption0);
        dcOption0.innerHTML = "Unassigned";
        dcOption0.value = "";
        for (let a = 0; a < ATEMCameras.length; a++) {
          let dcOption = document.createElement("option");
          dcSelect.appendChild(dcOption);
          dcOption.value = a;
          dcOption.innerHTML = ATEMCameras[a].name;
          if (DiscoveredCameras[i].ip == document.getElementById("camConfigIP" + a).value) {
            dcOption.selected = true;
          }
        }
      }
      let dc = document.getElementById("discoveredCameras");
      dc.parentNode.replaceChild(div, dc);
    }

    // TODO Convert to pure JS
    async function discoverCameras(btn) {
      btn.disabled = true;
      btn.innerHTML =
        "<span class='spinner-border spinner-border-sm mx-2' role='status' aria-hidden='true'></span>Discovering Cameras...";
      if (location.protocol != "file:") {
        const response = await fetch('/discoverCameras');
        DiscoveredCameras = await response.json();
        console.log(DiscoveredCameras);
      }
      //document.getElementById('discoverModal').
      $('#discoverModal').modal('show');
      drawDiscoveredCameras();
      btn.disabled = false;
      btn.innerHTML = "Discover Cameras";
    }

    function collapseDisable(c) {
      for (let i = 1; i < 5; i++) {
        if (c == i) {
          document.getElementById("btnradio" + i).setAttribute('data-bs-toggle', 'disabled');
        } else {
          document.getElementById("btnradio" + i).setAttribute('data-bs-toggle', 'collapse');
        }
      }
      // Enable log fetching if you click logs
      if (c == 3 && location.protocol != "file:") {
        LogCallback = setInterval(function () {
          // Call a function repetatively with .2 Second interval
          getLogData();
        }, 200); //2000mSeconds update rate
      } else if (LogCallback && c != 3 && location.protocol != "file:") {
        clearInterval(LogCallback);
      }
      if (c == 4) {
        setupPTZSocket();
      } else {
        closePTZSocket();
      }
    }
    function closePTZSocket() {
      if (ptzSocket) ptzSocket.close();
    }
    function setupPTZSocket() {
      if (location.protocol != "file:") {
        console.log("connecting to ws://" + location.hostname + ":3000");
        ptzSocket = new WebSocket("ws://" + location.hostname + ":3000");

        ptzSocket.onopen = function (e) {
          console.log("[open] Connection established");
        };

        ptzSocket.onmessage = function (event) {
          console.log(`[message] Data received from server: ${event.data}`);
          let ptz = JSON.parse(event.data);
          document.getElementById("axisPan").value = ptz.pan;
          document.getElementById("panValue").innerHTML = ptz.pan;
          document.getElementById("panVisca").innerHTML = ptz.viscaPan;
          document.getElementById("axisTilt").value = ptz.tilt;
          document.getElementById("tiltValue").innerHTML = ptz.tilt;
          document.getElementById("tiltVisca").innerHTML = ptz.viscaTilt;
          document.getElementById("axisZoom").value = ptz.zoom;
          document.getElementById("zoomValue").innerHTML = ptz.zoom;
          document.getElementById("zoomVisca").innerHTML = ptz.viscaZoom;
        };

        ptzSocket.onclose = function (event) {
          if (event.wasClean) {
            console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
          } else {
            // e.g. server process killed or network down
            // event.code is usually 1006 in this case
            console.log('[close] Connection died');
          }
        };

        ptzSocket.onerror = function (error) {
          console.log(`[error]`);
        };
      }
    }

    function toggleStaticIP(e) {
      document.getElementById("staticIPAddr").disabled = !e.checked;
      document.getElementById("staticSubnetMask").disabled = !e.checked;
      document.getElementById("staticGateway").disabled = !e.checked;
    }

    function toggleCam(e) {
      var camNum = e.id.replace(/^\D+/g, '');
      document.getElementById("camConfigProtocol" + camNum).disabled = !e.checked;
      document.getElementById("camConfigIP" + camNum).disabled = !e.checked;
      document.getElementById("camConfigPort" + camNum).disabled = !e.checked;
    }

    function getLogData() {
      var xhttp = new XMLHttpRequest();

      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          let ld = document.getElementById("logData");
          if (ld) ld.innerHTML = this.responseText;
        }
      };
      xhttp.open("GET", "logData", true);
      xhttp.send();
    }

    function updateFilename() {
      let fileInput = document.getElementById("update");
      let fileButton = document.getElementById("fileName");
      fileButton.value = fileInput.value.replace(/^.*[\\\/]/, '');
    }
  </script>
</head>

<body class="nodisplay">
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="bootstrap" viewBox="0 0 118 94">
      <title>Bootstrap</title>
      <path fill-rule="evenodd" clip-rule="evenodd"
        d="M24.509 0c-6.733 0-11.715 5.893-11.492 12.284.214 6.14-.064 14.092-2.066 20.577C8.943 39.365 5.547 43.485 0 44.014v5.972c5.547.529 8.943 4.649 10.951 11.153 2.002 6.485 2.28 14.437 2.066 20.577C12.794 88.106 17.776 94 24.51 94H93.5c6.733 0 11.714-5.893 11.491-12.284-.214-6.14.064-14.092 2.066-20.577 2.009-6.504 5.396-10.624 10.943-11.153v-5.972c-5.547-.529-8.934-4.649-10.943-11.153-2.002-6.484-2.28-14.437-2.066-20.577C105.214 5.894 100.233 0 93.5 0H24.508zM80 57.863C80 66.663 73.436 72 62.543 72H44a2 2 0 01-2-2V24a2 2 0 012-2h18.437c9.083 0 15.044 4.92 15.044 12.474 0 5.302-4.01 10.049-9.119 10.88v.277C75.317 46.394 80 51.21 80 57.863zM60.521 28.34H49.948v14.934h8.905c6.884 0 10.68-2.772 10.68-7.727 0-4.643-3.264-7.207-9.012-7.207zM49.948 49.2v16.458H60.91c7.167 0 10.964-2.876 10.964-8.281 0-5.406-3.903-8.178-11.425-8.178H49.948z">
      </path>
    </symbol>
    <symbol id="home" viewBox="0 0 16 16">
      <path
        d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 0 .5-.5v-4h2v4a.5.5 0 0 0 .5.5H14a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.354 1.146zM2.5 14V7.707l5.5-5.5 5.5 5.5V14H10v-4a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v4H2.5z" />
    </symbol>
    <symbol id="speedometer2" viewBox="0 0 16 16">
      <path
        d="M8 4a.5.5 0 0 1 .5.5V6a.5.5 0 0 1-1 0V4.5A.5.5 0 0 1 8 4zM3.732 5.732a.5.5 0 0 1 .707 0l.915.914a.5.5 0 1 1-.708.708l-.914-.915a.5.5 0 0 1 0-.707zM2 10a.5.5 0 0 1 .5-.5h1.586a.5.5 0 0 1 0 1H2.5A.5.5 0 0 1 2 10zm9.5 0a.5.5 0 0 1 .5-.5h1.5a.5.5 0 0 1 0 1H12a.5.5 0 0 1-.5-.5zm.754-4.246a.389.389 0 0 0-.527-.02L7.547 9.31a.91.91 0 1 0 1.302 1.258l3.434-4.297a.389.389 0 0 0-.029-.518z" />
      <path fill-rule="evenodd"
        d="M0 10a8 8 0 1 1 15.547 2.661c-.442 1.253-1.845 1.602-2.932 1.25C11.309 13.488 9.475 13 8 13c-1.474 0-3.31.488-4.615.911-1.087.352-2.49.003-2.932-1.25A7.988 7.988 0 0 1 0 10zm8-7a7 7 0 0 0-6.603 9.329c.203.575.923.876 1.68.63C4.397 12.533 6.358 12 8 12s3.604.532 4.923.96c.757.245 1.477-.056 1.68-.631A7 7 0 0 0 8 3z" />
    </symbol>
    <symbol id="table" viewBox="0 0 16 16">
      <path
        d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm15 2h-4v3h4V4zm0 4h-4v3h4V8zm0 4h-4v3h3a1 1 0 0 0 1-1v-2zm-5 3v-3H6v3h4zm-5 0v-3H1v2a1 1 0 0 0 1 1h3zm-4-4h4V8H1v3zm0-4h4V4H1v3zm5-3v3h4V4H6zm4 4H6v3h4V8z" />
    </symbol>
    <symbol id="people-circle" viewBox="0 0 16 16">
      <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z" />
      <path fill-rule="evenodd"
        d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z" />
    </symbol>
    <symbol id="grid" viewBox="0 0 16 16">
      <path
        d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z" />
    </symbol>
    <symbol id="check-circle-fill" fill="currentColor" viewBox="0 0 16 16">
      <path
        d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z" />
    </symbol>
    <symbol id="info-fill" fill="currentColor" viewBox="0 0 16 16">
      <path
        d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z" />
    </symbol>
    <symbol id="exclamation-triangle-fill" fill="currentColor" viewBox="0 0 16 16">
      <path
        d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
    </symbol>
    <symbol id="joystick" fill="currentColor" class="bi bi-joystick" viewBox="0 0 16 16">
      <path
        d="M10 2a2 2 0 0 1-1.5 1.937v5.087c.863.083 1.5.377 1.5.726 0 .414-.895.75-2 .75s-2-.336-2-.75c0-.35.637-.643 1.5-.726V3.937A2 2 0 1 1 10 2z" />
      <path
        d="M0 9.665v1.717a1 1 0 0 0 .553.894l6.553 3.277a2 2 0 0 0 1.788 0l6.553-3.277a1 1 0 0 0 .553-.894V9.665c0-.1-.06-.19-.152-.23L9.5 6.715v.993l5.227 2.178a.125.125 0 0 1 .001.23l-5.94 2.546a2 2 0 0 1-1.576 0l-5.94-2.546a.125.125 0 0 1 .001-.23L6.5 7.708l-.013-.988L.152 9.435a.25.25 0 0 0-.152.23z" />
    </symbol>
    <symbol id="dash-circle-fill" fill="currentColor" class="bi bi-dash-circle-fill" viewBox="0 0 16 16">
      <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM4.5 7.5a.5.5 0 0 0 0 1h7a.5.5 0 0 0 0-1h-7z" />
    </symbol>
  </svg>
  <main>
    <div class="container">
      <header class="py-4">
        <a href="#" class="align-items-center text-dark text-decoration-none">
          <div class="row">
            <div class="col-auto my-0">
              <svg class="row bi" width="60" height="60">
                <use xlink:href="#joystick" />
              </svg>
            </div>
            <div class="col-9 my-0">
              <span class="row fs-2">Church Cam Controller</span>
              <span class="row fs-6"><i>PTZ made EZ</i></span>
            </div>
          </div>
        </a>
        <hr class="py-0 my-0" />
      </header>
      <div id="smsgBox" class="alert alert-success" role="alert" style="display: none;">
      </div>
    </div>

    <div class="container">
      <header class="d-flex justify-content-center py-3">
        <div class="btn-group-lg" role="group">
          <input type="radio" class="btn-check" data-bs-toggle="collapse" data-bs-target="#collapseStatus"
            name="btnradio" id="btnradio1" autocomplete="off" onclick="collapseDisable(1)" checked>
          <label class="btn btn-outline-primary px-2" for="btnradio1">Status</label>
          <input type="radio" class="btn-check" data-bs-toggle="collapse" data-bs-target="#collapseConfig"
            name="btnradio" id="btnradio2" autocomplete="off" onclick="collapseDisable(2)">
          <label class="btn btn-outline-primary px-2" for="btnradio2">Config</label>
          <input type="radio" class="btn-check" data-bs-toggle="collapse" data-bs-target="#collapseLogs" name="btnradio"
            id="btnradio3" autocomplete="off" onclick="collapseDisable(3)">
          <label class="btn btn-outline-primary px-2" for="btnradio3">Logs</label>
          <input type="radio" class="btn-check" data-bs-toggle="collapse" data-bs-target="#collapseFirmware"
            name="btnradio" id="btnradio4" autocomplete="off" onclick="collapseDisable(4)">
          <label class="btn btn-outline-primary px-2" for="btnradio4">Firmware</label>
        </div>
      </header>
    </div>

    <div class="b-example-divider"></div>
    <!--

    <hr class="mt-2 mb-3"/>

    <div class="border-top my-3"></div>
    <div class="divider py-1"><hr></div>
        -->


    <div class="accordion" id="accordionExample">
      <div class="accordion-item">
        <div id="collapseStatus" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">
          <div class="accordion-body">
            <div class="col-lg-10 mx-auto">
              <table class="table">
                <thead class="bg-dark text-light">
                  <tr>
                    <th scope="col">Network</th>
                    <th scope="col">IP</th>
                    <th scope="col">SSID</th>
                    <th scope="col">Info</th>
                  </tr>
                </thead>
                <tbody>
                  <tr id="networkStatus">
                    <th id="networkStatusClass" class="alert alert-success align-items-center" scope="row">
                      <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img">
                        <use id="networkStatusIcon" xlink:href="#check-circle-fill" />
                      </svg>
                      <span id="networkStatusName">
                        Template
                      </span>
                    </th>
                    <td id="networkStatusIP">10.0.4.10</td>
                    <td id="networkStatusSSID">-</td>
                    <td id="networkStatusInfo">-</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="divider py-3"></div>

            <div class="col-lg-10 mx-auto">
              <table class="table">
                <thead class="bg-primary text-light">
                  <tr>
                    <th scope="col">Device</th>
                    <th scope="col">IP</th>
                    <th scope="col">Proto</th>
                    <th scope="col">Port</th>
                  </tr>
                </thead>
                <tbody>
                  <tr id="atemSwitcher">
                    <th id="atemSwitcherClass" class="alert alert-success align-items-center" scope="row">
                      <div class="container-full">
                        <div class="row">
                          <svg class="col-auto align-center bi flex-shrink-0" width="24" height="24" role="img">
                            <use id="atemSwitcherIcon" xlink:href="#check-circle-fill" />
                          </svg>
                          <div id="atemSwitcherName" class="col-auto px-0">
                            ATEM
                          </div>
                          <div id="atemSwitcherName2" class="col fs-6 fw-light fst-italic">-</div>
                        </div>
                      </div>
                    </th>
                    <td id="atemSwitcherIP">10.0.4.10</td>
                    <td id="atemSwitcherProtocol">TCP</td>
                    <td id="atemSwitcherPort">1234</td>
                  </tr>
                  <!-- Options
1- generate all html from JS array - could help redraw if needed
2- hardcode html and update all data from JS
3- hardcode html and just update html status icons and color/class
4-*** Hardcode ONE html and copy it for the others - maybe a dummy table row
-->
                  <tr id="camStatus">
                    <th id="camStatusClass" class="alert align-items-center alert-dark" scope="row">
                      <div class="container-full">
                        <div class="row">
                          <svg class="col-auto align-center bi flex-shrink-0" width="24" height="24" role="img">
                            <use id="camStatusIcon" xlink:href="#exclamation-triangle-fill" />
                          </svg>
                          <div id="camStatusName" class="col-auto px-0">
                            Cam1
                          </div>
                          <div id="camStatusHost" class="col fs-6 fw-light fst-italic">-</div>
                        </div>
                      </div>
                    </th>
                    <td id="camStatusIP"></td>
                    <td id="camStatusProtocol"></td>
                    <td id="camStatusPort"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <!-- Config Accordian -->
      <div class="accordion-item">
        <div id="collapseConfig" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
          <div class="accordion-body container-full">
            <form action="/save" method="POST" class="row col mx-auto needs-validation" novalidate>
              <ul class="nav nav-tabs">
                <li class="nav-item">
                  <div class="nav-link active bg-primary text-light" style="border:0px" href="#">Network Config</div>
                </li>
              </ul>
              <span class="border border-primary py-3">
                <div class="form-floating">
                  <input name="networkName" type="text" class="form-control" id="networkName" placeholder="ssid" value="%SSID%">
                  <label for="networkName">Network Name (SSID)</label>
                </div>
                <div class="form-floating">
                  <input name="networkPassword" type="password" class="form-control" id="networkPassword" placeholder="password" value="%PSK%">
                  <label for="networkPassword">Network Password</label>
                </div>
                <div class="form-check form-switch">
                  <input name="staticIPToggle" class="form-check-input" type="checkbox" role="switch" id="staticIPToggle"
                    onclick="toggleStaticIP(this)" %STATIC_IP%>
                  <label class="form-check-label" for="staticIPToggle">Static IP Address?</label>
                </div>
                <div class="form-floating">
                  <input name="staticIPAddr" type="text" class="form-control" id="staticIPAddr" placeholder="0.0.0.0"
                    value="%STATIC_IP_ADDR%" minlength="7" maxlength="15" size="15"
                    pattern="^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$">
                  <label for="networkPassword">Static IP</label>
                  <div class="invalid-feedback">
                    Please provide a valie IP address.
                  </div>
                </div>
                <div class="form-floating">
                  <input name="staticSubnetMask" type="text" class="form-control" id="staticSubnetMask" placeholder="0.0.0.0"
                    value="%STATIC_SUBNET_MASK%" minlength="7" maxlength="15" size="15"
                    pattern="^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$">
                  <label for="networkPassword">Static Subnet Mask</label>
                  <div class="invalid-feedback">
                    Please provide a valie IP address.
                  </div>
                </div>
                <div class="form-floating">
                  <input name="staticGateway" type="text" class="form-control" id="staticGateway" placeholder="0.0.0.0"
                    value="%STATIC_GATEWAY%" minlength="7" maxlength="15" size="15"
                    pattern="^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$">
                  <label for="networkPassword">Static Gateway</label>
                  <div class="invalid-feedback">
                    Please provide a valie IP address.
                  </div>
                </div>
              </span>

              <ul class="nav nav-tabs pt-4">
                <li class="nav-item">
                  <div class="nav-link active bg-primary text-light" style="border:0px" href="#">Device Config</div>
                </li>
              </ul>
              <span class="border border-primary py-3">
                <div class="input-group mb-3">
                  <span id="atemConfigName" class="input-group-text" id="basic-addon1">ATEM Mini Pro</span>
                  <input name="atemConfigIP" type="text" class="form-control" id="atemConfigIP" placeholder="0.0.0.0" value="%ATEM_IP_ADDR%"
                    minlength="7" maxlength="15" size="15"
                    pattern="^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$">
                </div>

                <!-- Button trigger modal -->
                <button id="discoverCamerasButton" type="button" class="btn btn-success py-2 my-2 col-12"
                  xdata-bs-toggle="modal" data-bs-target="#discoverModalX" onclick="discoverCameras(this)">Discover
                  Cameras</button>
                <!-- Modal -->
                <div class="modal fade" id="discoverModal" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Assign Discovered Cameras</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <div id="discoveredCameras">Discovering Cameras</div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal"
                          onclick="assignDiscoveredCameras()">Save changes</button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="container-full px-0">
                  <!-- Working Template -->
                  <div id="camConfig" class="input-group mb-3 mx-0 row">
                    <!--
                    <div class="input-group-text col-md-auto col-auto">
                      <input name="camConfigToggle" class="form-check-input mt-0" type="checkbox" id="camConfigToggle"
                        onclick="toggleCam(this)" checked>
                    </div>
                  -->
                    <div id="camConfigName" class="input-group-text flex-grow-1 col-md-3 col-6" id="basic-addon1">CAM1
                      [ATEM In1]</div>
                    <div class="col-md-3 col-5 px-0">
                      <select name="camConfigProtocol" class="form-select" id="camConfigProtocol"> <!-- required -->
                        <option value="" selected>Protocol</option>
                        <option value="0">VISCA UDP</option>
                        <option value="1">VISCA TCP</option>
                        <option value="2">ONVIF TCP</option>
                      </select>
                    </div>
                    <div class="col-md-3 col-6 px-0">
                      <input name="camConfigIP" type="text" class="form-control" id="camConfigIP" placeholder="0.0.0.0" value=""
                        minlength="7" maxlength="15" size="15"
                        pattern="^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$">
                    </div>
                    <div class="col-md-2 col-6 px-0">
                      <input name="camConfigPort" type="text" class="form-control" id="camConfigPort" placeholder="52381" value=""
                        minlength="1" maxlength="5" size="5" pattern="^(\d{1,5})$">
                    </div>
                  </div>
                  <!-- End Camera Config Template-->
                </div>
              </span>
              <button type="submit" class="btn btn-primary py-3 my-3">Submit</button>
            </form>
          </div>
        </div>
      </div>
      <!-- Logs Accordian -->
      <div class="accordion-item">
        <div id="collapseLogs" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
          <div class="accordion-body">
            <div>
              <span class="alert alert-info mb-1 py-1">Info</span>
              <span class="alert alert-light mb-1 py-1">Debug</span>
              <span class="alert alert-warning mb-1 py-1">Warn</span>
              <span class="alert alert-danger mb-1 py-1">Error</span>
            </div>
            <div id="logData"></div>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <div id="collapseFirmware" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
          <div class="accordion-body">
            <div class="container-full">
              <!-- Device Info -->
              <div class="row fs-5 mb-3">
                <ul class="nav nav-tabs">
                  <li class="nav-item">
                    <div class="nav-link active bg-primary text-light" style="border:0px" href="#">Internals</div>
                  </li>
                </ul>
                <span class="border border-primary py-3">
                  <div class="input-group mb-3">
                    <span class="input-group-text col-3">Hardware:</span>
                    <span class="input-group-text bg-white col-9">%BOARD_NAME%</span>
                  </div>
                  <!-- Joystick Info -->
                  <div class="row">
                    <div class="col-3">Pan:</div>
                    <div id="panValue" class="col-3"></div>
                    <div class="col-3">Visca:</div>
                    <div id="panVisca" class="col-3"></div>
                  </div>
                  <div id="joystickContainer">
                    <div id="joystickDeadZone">
                      <input id="axisPan" type="range" class="form-range align-bottom" min="0" max="4096">
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-3">Tilt:</div>
                    <div id="tiltValue" class="col-3"></div>
                    <div class="col-3">Visca:</div>
                    <div id="tiltVisca" class="col-3"></div>
                  </div>
                  <div id="joystickContainer">
                    <div id="joystickDeadZone">
                      <input id="axisTilt" type="range" class="form-range align-bottom" min="0" max="4096">
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-3">Zoom:</div>
                    <div id="zoomValue" class="col-3"></div>
                    <div class="col-3">Visca:</div>
                    <div id="zoomVisca" class="col-3"></div>
                  </div>
                  <div id="joystickContainer">
                    <div id="joystickDeadZone">
                      <input id="axisZoom" type="range" class="form-range align-bottom" min="0" max="4096">
                    </div>
                  </div>
                </span>
              </div>
              <!-- Restart Button -->
              <div class="row">
                <button type="button" class="btn btn-success btn-lg btn-block"
                  onclick="location.href='/restart';">Restart Joystick</button>
              </div>
              <hr class="my-4">
              <!-- Upload Button -->
              <div class="row">
                <button type="button" class="btn btn-warning btn-lg btn-block" onclick="location.href='/erase';">Reset
                  All Data</button>
              </div>
              <hr class="my-4">
              <!-- Best post on this -->
              <!-- https://tympanus.net/codrops/2015/09/15/styling-customizing-file-inputs-smart-way/ -->
              <!-- https://www.quirksmode.org/dom/inputfile.html -->
              <form method='POST' action='#' enctype='multipart/form-data' id='upload_form'>
                <div class="input-group">
                  <label id="fileButton" class="btn btn-success btn-lg btn-block" for="update">Choose .bin file:</label>
                  <input id="fileName" class="form-control" type="text" placeholder="" readonly>
                  <input type='file' id="update" class="form-control-file" name='update' accept=".bin"
                    onchange="updateFilename()" style="display:none;">
                  <input type='submit' class="btn btn-primary btn-lg px-5" value='Update'>
                </div>
                <div class="progress my-3" role="progressbar" aria-label="Basic example" aria-valuenow="0"
                  aria-valuemin="0" aria-valuemax="100">
                  <div id="prg" class="progress-bar" style="width: 0%"></div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>

    <div class="b-example-divider"></div>

  </main>
  <script>
    updateNetworks();
    updateSwitcherStatus();
    updateCameraStatus();
    updateCameraConfig();
    toggleStaticIP(document.getElementById("staticIPToggle"));
    document.body.classList.remove("nodisplay");

    const urlParams = new URLSearchParams(window.location.search);
    const smsg = urlParams.get('success')
    if (smsg) {
      document.getElementById("smsgBox").innerHTML = smsg;
      document.getElementById("smsgBox").style.display = 'block';
    }

    /* TODO Change to JavaScript fetch API? and get rid of jquery */
    $('#upload_form').submit(function (e) {
      e.preventDefault();
      var form = $('#upload_form')[0];
      var data = new FormData(form);
      $.ajax({
        url: '/update',
        type: 'POST',
        data: data,
        contentType: false,
        processData: false,
        xhr: function () {
          var xhr = new window.XMLHttpRequest();
          xhr.upload.addEventListener('progress', function (evt) {
            if (evt.lengthComputable) {
              var per = evt.loaded / evt.total;
              per = Math.round(per * 100);
              $('#prg').width(per + '%');
            }
          }, false);
          return xhr;
        },
        success: function (d, s) {
          console.log('success!')
          window.location.href = '/restart';
        },
        error: function (a, b, c) {
        }
      });
    });
  </script>
</body>

</html>